!function(o){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],o):"object"==typeof module&&module.exports?module.exports=function(r,e){return r||(r=window),void 0===e&&(e="undefined"!=typeof window?require("jquery"):require("jquery")(r)),require("./grid.base"),o(e),e}:o(jQuery)}(function(T){"use strict";var B=T.jgrid,M=T.fn.jqGrid;B.extend({groupingSetup:function(){return this.each(function(){var r,e,o,i,t,n=this,a=n.p,l=a.colModel,u=a.groupingView,s=function(){return""};if(null===u||"object"!=typeof u&&!T.isFunction(u))a.grouping=!1;else if(u.groupField.length){for(void 0===u.visibiltyOnNextGrouping&&(u.visibiltyOnNextGrouping=[]),u.lastvalues=[],u._locgr||(u.groups=[]),u.counters=[],r=0;r<u.groupField.length;r++)u.groupOrder[r]||(u.groupOrder[r]="asc"),u.groupText[r]||(u.groupText[r]="{0}"),"boolean"!=typeof u.groupColumnShow[r]&&(u.groupColumnShow[r]=!0),"boolean"!=typeof u.groupSummary[r]&&(u.groupSummary[r]=!1),u.groupSummaryPos[r]||(u.groupSummaryPos[r]="footer"),i=l[a.iColByName[u.groupField[r]]],!0===u.groupColumnShow[r]?(u.visibiltyOnNextGrouping[r]=!0,null!=i&&!0===i.hidden&&M.showCol.call(T(n),u.groupField[r])):(u.visibiltyOnNextGrouping[r]=T("#"+B.jqID(a.id+"_"+u.groupField[r])).is(":visible"),null!=i&&!0!==i.hidden&&M.hideCol.call(T(n),u.groupField[r]));for(u.summary=[],u.hideFirstGroupCol&&(u.formatDisplayField[0]=function(r){return r}),e=0,o=l.length;e<o;e++)i=l[e],u.hideFirstGroupCol&&(i.hidden||u.groupField[0]!==i.name||(i.formatter=s)),i.summaryType&&(t={nm:i.name,st:i.summaryType,v:"",sr:i.summaryRound,srt:i.summaryRoundType||"round"},i.summaryDivider&&(t.sd=i.summaryDivider,t.vd=""),u.summary.push(t))}else a.grouping=!1})},groupingPrepare:function(F,C){return this.each(function(){var r,e,o,i,t,n,a,l,u,s=this,d=s.p,p=d.groupingView,g=p.groups,m=p.counters,f=p.lastvalues,c=p.isInTheSameGroup,h=p.groupField.length,y=!1,v=M.groupingCalculations.handler,x=function(){var r,e,o;for(r=0;r<t.summary.length;r++)e=t.summary[r],o=T.isArray(e.st)?e.st[i.idx]:e.st,T.isFunction(o)?e.v=o.call(s,e.v,e.nm,F,i):(e.v=v.call(T(s),o,e.v,e.nm,e.sr,e.srt,F),"avg"===o.toLowerCase()&&e.sd&&(e.vd=v.call(T(s),o,e.vd,e.sd,e.sr,e.srt,F)));return t.summary},w=function(r,e){var o,i=void 0!==d.iColByName[e]?d.colModel[d.iColByName[e]]:d.additionalProperties[d.iPropByName[e]],t=r;if(null==r&&p.useDefaultValuesOnGrouping)null!=i&&null!=i.formatter&&(null!=i.formatoptions&&void 0!==i.formatoptions.defaultValue?r=i.formatoptions.defaultValue:"string"==typeof i.formatter&&void 0!==(o=T(s).jqGrid("getGridRes","formatter."+i.formatter+".defaultValue"))&&(t=o));else if("function"==typeof i.formatter){var n=d.iColByName[e],a={rowId:C,colModel:i,gid:d.id,pos:n,rowData:F};t=i.formatter.call(s,r,a,F)}return t};for(r=0;r<h;r++)if(n=p.groupField[r],a=w(F[n],n),null==(u=null==(l=p.displayField[r])?null:w(F[l],l))&&(u=a),void 0!==a){for(o=[],e=0;e<=r;e++)o.push(F[p.groupField[e]]);for(i={idx:r,dataIndex:n,value:a,displayValue:u,startRow:C,cnt:1,keys:o,summary:[]},t={cnt:1,pos:g.length,summary:T.extend(!0,[],p.summary)},0===C?(g.push(i),f[r]=a,m[r]=t):"object"==typeof a||(T.isArray(c)&&T.isFunction(c[r])?c[r].call(s,f[r],a,r,p):f[r]===a)?y?(g.push(i),f[r]=a,m[r]=t):((t=m[r]).cnt+=1,g[t.pos].cnt=t.cnt):(g.push(i),f[r]=a,y=!0,m[r]=t),g[t.pos].summary=x(),e=t.pos-1;0<=e;e--)if(g[e].idx<g[t.pos].idx){g[t.pos].parentGroupIndex=e,g[t.pos].parentGroup=g[e];break}}}),this},getGroupHeaderIndex:function(r,e){var o=this[0].p,i=e?T(e).closest("tr.jqgroup"):T("#"+B.jqID(r)),t=parseInt(i.data("jqgrouplevel"),10),n=o.id+"ghead_"+t+"_";return isNaN(t)||!i.hasClass("jqgroup")||r.length<=n.length?-1:parseInt(r.substring(n.length),10)},groupingToggle:function(c,h){return this.each(function(){var r,e,o,i=this,t=i.p,n=t.groupingView,a=n.minusicon,l=n.plusicon,u=h?T(h).closest("tr.jqgroup"):T("#"+B.jqID(c)),s=function(r){return r.find(">td>span.tree-wrap")},d=!0,p=!1,g=[],m=function(r){var e,o=r.length;for(e=0;e<o;e++)g.push(r[e])},f=parseInt(u.data("jqgrouplevel"),10);for(t.frozenColumns&&0<u.length&&(e=u[0].rowIndex,u=(u=T(i.rows[e])).add(i.grid.fbRows[e])),o=s(u),B.hasAllClasses(o,a)?(o.removeClass(a).addClass(l),p=!0):o.removeClass(l).addClass(a),u=u.next();u.length;u=u.next())if(u.hasClass("jqfoot")){if(r=parseInt(u.data("jqfootlevel"),10),p){if(r=parseInt(u.data("jqfootlevel"),10),(!n.showSummaryOnHide&&r===f||f<r)&&m(u),r<f)break}else if((r===f||n.showSummaryOnHide&&r===f+1)&&m(u),r<=f)break}else if(u.hasClass("jqgroup"))if(r=parseInt(u.data("jqgrouplevel"),10),p){if(r<=f)break;m(u)}else{if(r<=f)break;r===f+1&&(s(u).removeClass(a).addClass(l),m(u)),d=!1}else(p||d)&&m(u);T(g).css("display",p?"none":""),t.frozenColumns&&T(i).triggerHandler("jqGridResetFrozenHeights",[{header:{resizeDiv:!1,resizedRows:{iRowStart:-1,iRowEnd:-1}},resizeFooter:!1,body:{resizeDiv:!0,resizedRows:{iRowStart:e,iRowEnd:u.length?u[0].rowIndex-1:-1}}}]),i.fixScrollOffsetAndhBoxPadding(),T(i).triggerHandler("jqGridGroupingClickGroup",[c,p]),T.isFunction(t.onClickGroup)&&t.onClickGroup.call(i,c,p)}),!1},groupingRender:function(v,x){var w="",C=this[0],j=C.p,F=0,b=[],q=j.groupingView,G=T.makeArray(q.groupSummary),S=q.groupField.length,N=q.groups,R=j.colModel,I=R.length,V=j.page,r="jqGridShowHideCol.groupingRender",e=function(r){return M.getGuiStyles.call(C,"gridRow",r)},O=e("jqgroup ui-row-"+j.direction),k=e("jqfoot ui-row-"+j.direction);function D(r,e,o,i,t){var n,a,l,u,s,d,p,g,m,f,c,h,y,v=N[r],x="",w=0,F=!0;if(0!==e&&0!==N[r].idx)for(n=r;0<=n;n--)if(N[n].idx===N[r].idx-e){v=N[n];break}for(a=v.cnt,c=void 0===t?i:0;c<I;c++){for(l="&#160;",f=R[c],g=0;g<v.summary.length;g++)if(m=v.summary[g],h=T.isArray(m.st)?m.st[o.idx]:m.st,y=T.isArray(f.summaryTpl)?f.summaryTpl[o.idx]:f.summaryTpl||"{0}",m.nm===f.name){"string"==typeof h&&"avg"===h.toLowerCase()&&(m.sd&&m.vd?m.v=m.v/m.vd:m.v&&0<a&&(m.v=m.v/a));try{m.groupCount=v.cnt,m.groupIndex=v.dataIndex,m.groupValue=v.value,d=C.formatter("",m.v,c,m)}catch(r){d=m.v}l=B.format(y,d),f.summaryFormat&&(l=f.summaryFormat.call(C,o,l,d,f,m));break}s=u=!1,void 0!==t&&F&&(f.hidden||(l=t,F=!1,1<i&&(u=!0,w=i-1),s=f.align,f.align="rtl"===j.direction?"right":"left",q.iconColumnName=f.name)),p=!1,0<w&&!f.hidden&&"&#160;"===l?(p=!0,s&&(f.align=s),w--):(x+="<td role='gridcell' "+C.formatCol(c,1,"")+(u?"colspan='"+i+"'":"")+">"+l+"</td>",u=!1,s&&(f.align=s),p&&(f.hidden=!1,w--))}return x}return T.each(R,function(r,e){var o;for(o=0;o<S;o++)if(q.groupField[o]===e.name){b[o]=r;break}}),G.reverse(),T.each(N,function(r,e){var o,i,t,n,a,l,u,s,d=j.id+"ghead_"+e.idx,p=d+"_"+r,g=T.isFunction(q.groupCollapse)?q.groupCollapse.call(C,{group:e,rowid:p}):q.groupCollapse,m=1,f=0,c=S-1===e.idx,h=null!=e.parentGroup&&e.parentGroup.collapsed,y="<span style='cursor:pointer;margin-"+("rtl"===j.direction?"right:":"left:")+12*e.idx+"px;' class='"+q.commonIconClass+" "+(g?q.plusicon:q.minusicon)+" tree-wrap'></span>";if(q._locgr&&!(e.startRow+e.cnt>(V-1)*x&&e.startRow<V*x))return!0;h&&(g=!0),void 0!==g&&(e.collapsed=g),F++;try{o=T.isArray(q.formatDisplayField)&&T.isFunction(q.formatDisplayField[e.idx])?(e.displayValue=q.formatDisplayField[e.idx].call(C,e.displayValue,e.value,R[b[e.idx]],e.idx,e,r),e.displayValue):C.formatter(p,e.displayValue,b[e.idx],e.value,e)}catch(r){o=e.displayValue}if(w+="<tr id='"+p+"' data-jqgrouplevel='"+e.idx+"' "+(g&&h?"style='display:none;' ":"")+"role='row' class='"+O+" "+d+"'>","string"!=typeof(s=T.isFunction(q.groupText[e.idx])?q.groupText[e.idx].call(C,o,e.cnt,e.summary):B.template(q.groupText[e.idx],o,e.cnt,e.summary))&&"number"!=typeof s&&(s=o),"header"===q.groupSummaryPos[e.idx]?(m=1,"cb"!==R[0].name&&"cb"!==R[1].name||m++,"subgrid"!==R[0].name&&"subgrid"!==R[1].name||m++,w+=D(r,0,e,m,y+"<span class='cell-wrapper'>"+s+"</span>")):w+="<td role='gridcell' style='padding-left:"+12*e.idx+"px;' colspan='"+I+"'>"+y+s+"</td>",w+="</tr>",c){for(l=N[r+1],a=e.startRow,u=void 0!==l?l.startRow:N[r].startRow+N[r].cnt,q._locgr&&(f=(V-1)*x)>e.startRow&&(a=f),t=a;t<u&&v[t-f];t++)w+=v[t-f].join("");if("header"!==q.groupSummaryPos[e.idx]){if(void 0!==l){for(i=0;i<q.groupField.length&&l.dataIndex!==q.groupField[i];i++);F=q.groupField.length-i}for(n=0;n<F;n++)G[n]&&(w+="<tr data-jqfootlevel='"+(e.idx-n)+(g&&(0<e.idx-n||!q.showSummaryOnHide)?"' style='display:none;'":"'")+" role='row' class='"+k+"'>",w+=D(r,n,N[e.idx-n],0),w+="</tr>");F=i}}}),this.off(r).on(r,function(){var r,e,o,i,t=j.iColByName[q.iconColumnName];if(0<=T.inArray("header",q.groupSummaryPos)){for(i=0;i<R.length;i++)if(!R[i].hidden){o=i;break}if(void 0===o||t===o)return;for(r=0;r<C.rows.length;r++)e=C.rows[r],T(e).hasClass("jqgroup")&&(T(e.cells[o]).html(e.cells[t].innerHTML),T(e.cells[t]).html("&nbsp;"));q.iconColumnName=R[o].name}}),w},groupingGroupBy:function(t,n){return this.each(function(){var r,e,o=this.p,i=o.groupingView;for("string"==typeof t&&(t=[t]),o.grouping=!0,i._locgr=!1,void 0===i.visibiltyOnNextGrouping&&(i.visibiltyOnNextGrouping=[]),r=0;r<i.groupField.length;r++)e=o.colModel[o.iColByName[i.groupField[r]]],!i.groupColumnShow[r]&&i.visibiltyOnNextGrouping[r]&&null!=e&&!0===e.hidden&&M.showCol.call(T(this),i.groupField[r]);for(r=0;r<t.length;r++)i.visibiltyOnNextGrouping[r]=T(o.idSel+"_"+B.jqID(t[r])).is(":visible");o.groupingView=T.extend(o.groupingView,n||{}),i.groupField=t,T(this).trigger("reloadGrid")})},groupingRemove:function(t){return this.each(function(){var r,e=this.p,o=this.tBodies[0],i=e.groupingView;if(void 0===t&&(t=!0),!(e.grouping=!1)===t){for(r=0;r<i.groupField.length;r++)!i.groupColumnShow[r]&&i.visibiltyOnNextGrouping[r]&&M.showCol.call(T(this),i.groupField);T("tr.jqgroup, tr.jqfoot",o).remove(),T("tr.jqgrow",o).filter(":hidden").show()}else T(this).trigger("reloadGrid")})},groupingCalculations:{handler:function(r,e,o,i,t,n){var a,l,u={sum:function(){return parseFloat(e||0)+parseFloat(n[o]||0)},min:function(){return""===e?parseFloat(n[o]||0):Math.min(parseFloat(e),parseFloat(n[o]||0))},max:function(){return""===e?parseFloat(n[o]||0):Math.max(parseFloat(e),parseFloat(n[o]||0))},count:function(){return""===e&&(e=0),n.hasOwnProperty(o)?e+1:0},avg:function(){return u.sum()}};if(!u[r])throw"jqGrid Grouping No such method: "+r;return a=u[r](),null!=i&&(a="fixed"===t?a.toFixed(i):(l=Math.pow(10,i),Math.round(a*l)/l)),a}}})});
//# sourceMappingURL=grid.grouping.js.map